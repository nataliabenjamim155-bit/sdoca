<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CRUD Completo — LocalStorage</title>

    <!-- Bootstrap 5 (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: #f6f8fb;
        }

        .card {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        .avatar-preview {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .no-data {
            text-align: center;
            color: #777;
            padding: 20px;
        }

        @media (max-width: 575px) {
            .table-responsive {
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Sistema CRUD — LocalStorage</h3>
            <div>
                <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm"><i class="fa fa-file-csv"></i>
                    Exportar CSV</button>
                <button id="btnExportJSON" class="btn btn-outline-secondary btn-sm"><i class="fa fa-file-code"></i>
                    Exportar JSON</button>
                <button id="btnPrint" class="btn btn-outline-secondary btn-sm"><i class="fa fa-print"></i> Imprimir /
                    PDF</button>
            </div>
        </div>

        <div class="row g-3">
            <!-- FORM -->
            <div class="col-lg-4">
                <div class="card p-3">
                    <h5>Adicionar / Editar Estudante</h5>
                    <form id="formAluno" novalidate>
                        <input type="hidden" id="alunoId">

                        <div class="mb-2">
                            <label class="form-label">Nome *</label>
                            <input id="nome" class="form-control" required>
                            <div class="invalid-feedback">Nome obrigatório</div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Email *</label>
                            <input id="email" type="email" class="form-control" required>
                            <div class="invalid-feedback">Email válido obrigatório</div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Telefone</label>
                            <input id="telefone" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Idade</label>
                            <input id="idade" type="number" min="0" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Número do Estudante</label>
                            <input id="numero" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Curso</label>
                            <input id="curso" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Bilhete de Identidade (BI)</label>
                            <input id="bi" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Morada</label>
                            <input id="morada" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Foto (opcional)</label>
                            <input id="foto" type="file" accept="image/*" class="form-control">
                            <div class="mt-2">
                                <img id="preview" class="avatar-preview" src="" alt="" style="display:none">
                                <button id="remFoto" type="button" class="btn btn-sm btn-link text-danger"
                                    style="display:none">Remover foto</button>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-primary" id="btnSalvar" type="submit"><i class="fa fa-save"></i>
                                Salvar</button>
                            <button class="btn btn-secondary" id="btnLimpar" type="button">Limpar</button>
                            <button class="btn btn-danger ms-auto" id="btnApagarTudo" type="button"><i
                                    class="fa fa-trash"></i> Apagar tudo</button>
                        </div>
                    </form>
                </div>

                <div class="mt-3 card p-3">
                    <h6 class="mb-2">Pesquisar / Filtros</h6>
                    <div class="mb-2">
                        <input id="search" class="form-control" placeholder="Pesquisar por nome, email, curso, BI...">
                    </div>
                    <div class="d-flex gap-2">
                        <select id="filtrarCurso" class="form-select">
                            <option value="">Filtrar por curso (Todos)</option>
                        </select>
                        <button id="btnClearFilters" class="btn btn-outline-secondary">Limpar</button>
                    </div>
                </div>

            </div>

            <!-- TABLE -->
            <div class="col-lg-8">
                <div class="card p-3">
                    <div class="d-flex justify-content-between mb-2 align-items-center">
                        <strong>Lista de Estudantes</strong>
                        <div>
                            <small class="text-muted me-2">Ordenar:</small>
                            <button id="orderAsc" class="btn btn-sm btn-outline-primary">A→Z</button>
                            <button id="orderDesc" class="btn btn-sm btn-outline-primary">Z→A</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="sortable" data-key="nome">Nome <i class="fa fa-sort"></i></th>
                                    <th class="sortable" data-key="email">Email <i class="fa fa-sort"></i></th>
                                    <th class="sortable" data-key="curso">Curso <i class="fa fa-sort"></i></th>
                                    <th>Telefone</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaBody"></tbody>
                        </table>
                    </div>

                    <div id="noData" class="no-data" style="display:none">Nenhum registro encontrado.</div>

                    <!-- Paginação simples -->
                    <nav aria-label="Navegação tabela">
                        <ul class="pagination pagination-sm justify-content-center mt-3" id="paginacao"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de visualização -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Estudante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- preenchido via JS -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /*
          CRUD completo em single file:
          - Usa localStorage com chave 'crudAlunos'
          - Campos: nome, email, telefone, idade, numero, curso, bi, morada, foto (base64)
          - Recursos: criar, listar, editar (modal + form), apagar um, apagar tudo, pesquisa, filtros, ordenação, paginação, export CSV/JSON, imprimir
        */

        const LS_KEY = 'crudAlunos';
        let dados = [];
        let currentSort = { key: null, dir: 1 }; // 1 asc, -1 desc
        let paginaAtual = 1;
        const itensPorPagina = 6;

        // Elementos
        const form = document.getElementById('formAluno');
        const tabelaBody = document.getElementById('tabelaBody');
        const noData = document.getElementById('noData');
        const preview = document.getElementById('preview');
        const remFoto = document.getElementById('remFoto');
        const fotoInput = document.getElementById('foto');
        const searchInput = document.getElementById('search');
        const filtrarCurso = document.getElementById('filtrarCurso');
        const paginacaoEl = document.getElementById('paginacao');

        const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));

        // --- Utilitários ---
        function gerarId() {
            return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        }

        function salvarLS() {
            localStorage.setItem(LS_KEY, JSON.stringify(dados));
        }

        function carregarLS() {
            dados = JSON.parse(localStorage.getItem(LS_KEY)) || [];
        }

        // --- Foto preview e leitura como base64 ---
        fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { limparPreview(); return; }
            const reader = new FileReader();
            reader.onload = function (evt) {
                preview.src = evt.target.result;
                preview.style.display = 'inline-block';
                remFoto.style.display = 'inline-block';
                preview.dataset.has = '1';
            };
            reader.readAsDataURL(file);
        });

        remFoto.addEventListener('click', () => {
            limparPreview();
            fotoInput.value = '';
        });

        function limparPreview() {
            preview.src = '';
            preview.style.display = 'none';
            remFoto.style.display = 'none';
            preview.dataset.has = '';
        }

        // --- Form: salvar/atualizar ---
        form.addEventListener('submit', (ev) => {
            ev.preventDefault();
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const id = document.getElementById('alunoId').value;
            const aluno = {
                id: id || gerarId(),
                nome: document.getElementById('nome').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                idade: document.getElementById('idade').value,
                numero: document.getElementById('numero').value.trim(),
                curso: document.getElementById('curso').value.trim(),
                bi: document.getElementById('bi').value.trim(),
                morada: document.getElementById('morada').value.trim(),
                foto: ''
            };

            // se tiver preview atual (base64), usa; se estiver editando e não alterou foto, mantém antiga
            if (preview.dataset.has === '1') {
                aluno.foto = preview.src;
            } else if (id) {
                // manter foto existente se em edição e não tiver trocado
                const existente = dados.find(d => d.id === id);
                aluno.foto = existente ? existente.foto : '';
            }

            if (id) {
                // atualizar
                const idx = dados.findIndex(d => d.id === id);
                if (idx > -1) dados[idx] = aluno;
            } else {
                // novo
                dados.push(aluno);
            }

            salvarLS();
            carregarLS();
            preencherCursosFiltro();
            resetForm();
            renderTabela();
        });

        document.getElementById('btnLimpar').addEventListener('click', resetForm);

        // --- Reset form ---
        function resetForm() {
            form.reset();
            document.getElementById('alunoId').value = '';
            form.classList.remove('was-validated');
            limparPreview();
        }

        // --- Preencher cursos no filtro (únicos) ---
        function preencherCursosFiltro() {
            const cursos = Array.from(new Set(dados.map(d => d.curso).filter(Boolean))).sort();
            filtrarCurso.innerHTML = '<option value="">Filtrar por curso (Todos)</option>';
            cursos.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                filtrarCurso.appendChild(opt);
            });
        }

        // --- Render tabela com paginação, pesquisa e ordenação ---
        function renderTabela() {
            let list = [...dados];

            // filtros
            const termo = searchInput.value.trim().toLowerCase();
            if (termo) {
                list = list.filter(d => (
                    (d.nome || '').toLowerCase().includes(termo) ||
                    (d.email || '').toLowerCase().includes(termo) ||
                    (d.curso || '').toLowerCase().includes(termo) ||
                    (d.bi || '').toLowerCase().includes(termo) ||
                    (d.numero || '').toLowerCase().includes(termo)
                ));
            }

            if (filtrarCurso.value) {
                list = list.filter(d => d.curso === filtrarCurso.value);
            }

            // ordenação
            if (currentSort.key) {
                list.sort((a, b) => {
                    const x = (a[currentSort.key] || '').toString().toLowerCase();
                    const y = (b[currentSort.key] || '').toString().toLowerCase();
                    return x < y ? -1 * currentSort.dir : x > y ? 1 * currentSort.dir : 0;
                });
            }

            // paginação
            const total = list.length;
            const totalPag = Math.max(1, Math.ceil(total / itensPorPagina));
            if (paginaAtual > totalPag) paginaAtual = totalPag;
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const paged = list.slice(inicio, inicio + itensPorPagina);

            tabelaBody.innerHTML = '';
            if (paged.length === 0) {
                noData.style.display = 'block';
            } else {
                noData.style.display = 'none';
                paged.forEach(item => {
                    const tr = document.createElement('tr');

                    // avatar
                    const tdImg = document.createElement('td');
                    tdImg.style.width = '72px';
                    if (item.foto) {
                        tdImg.innerHTML = `<img src="${item.foto}" class="avatar-preview" alt="foto">`;
                    } else {
                        tdImg.innerHTML = `<div class="avatar-preview d-flex align-items-center justify-content-center bg-light text-muted" style="font-size:12px">Sem foto</div>`;
                    }
                    tr.appendChild(tdImg);

                    // nome
                    const tdNome = document.createElement('td');
                    tdNome.textContent = item.nome;
                    tr.appendChild(tdNome);

                    const tdEmail = document.createElement('td'); tdEmail.textContent = item.email; tr.appendChild(tdEmail);
                    const tdCurso = document.createElement('td'); tdCurso.textContent = item.curso; tr.appendChild(tdCurso);
                    const tdTel = document.createElement('td'); tdTel.textContent = item.telefone; tr.appendChild(tdTel);

                    // acoes
                    const tdAcoes = document.createElement('td');
                    tdAcoes.innerHTML = `
        <div class="btn-group" role="group">
          <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${item.id}')"><i class="fa fa-eye"></i></button>
          <button class="btn btn-sm btn-outline-success" onclick="editarRegistro('${item.id}')"><i class="fa fa-edit"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="apagarRegistro('${item.id}')"><i class="fa fa-trash"></i></button>
        </div>
      `;
                    tr.appendChild(tdAcoes);

                    tabelaBody.appendChild(tr);
                });
            }

            renderPaginacao(totalPag);
        }

        // --- Paginação ---
        function renderPaginacao(totalPag) {
            paginacaoEl.innerHTML = '';
            for (let i = 1; i <= totalPag; i++) {
                const li = document.createElement('li');
                li.className = 'page-item ' + (i === paginaAtual ? 'active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => { e.preventDefault(); paginaAtual = i; renderTabela(); });
                paginacaoEl.appendChild(li);
            }
        }

        // --- Visualizar detalhes (modal) ---
        function verDetalhes(id) {
            const item = dados.find(d => d.id === id);
            if (!item) return;
            const html = `
    <div class="d-flex gap-3">
      <div>${item.foto ? `<img src="${item.foto}" style="width:120px;height:120px;object-fit:cover;border-radius:8px">` : `<div style="width:120px;height:120px;background:#f1f1f1;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#888">Sem foto</div>`}</div>
      <div>
        <h5>${item.nome}</h5>
        <p class="mb-1"><strong>Email:</strong> ${item.email}</p>
        <p class="mb-1"><strong>Telefone:</strong> ${item.telefone}</p>
        <p class="mb-1"><strong>Idade:</strong> ${item.idade}</p>
        <p class="mb-1"><strong>Nº Estudante:</strong> ${item.numero}</p>
        <p class="mb-1"><strong>Curso:</strong> ${item.curso}</p>
        <p class="mb-1"><strong>BI:</strong> ${item.bi}</p>
        <p class="mb-0"><strong>Morada:</strong> ${item.morada}</p>
      </div>
    </div>
  `;
            document.getElementById('modalBody').innerHTML = html;
            viewModal.show();
        }

        // --- Editar registro: preenche form ---
        function editarRegistro(id) {
            const item = dados.find(d => d.id === id);
            if (!item) return;
            document.getElementById('alunoId').value = item.id;
            document.getElementById('nome').value = item.nome;
            document.getElementById('email').value = item.email;
            document.getElementById('telefone').value = item.telefone;
            document.getElementById('idade').value = item.idade;
            document.getElementById('numero').value = item.numero;
            document.getElementById('curso').value = item.curso;
            document.getElementById('bi').value = item.bi;
            document.getElementById('morada').value = item.morada;

            if (item.foto) {
                preview.src = item.foto;
                preview.style.display = 'inline-block';
                remFoto.style.display = 'inline-block';
                preview.dataset.has = '1';
            } else {
                limparPreview();
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Apagar um registro ---
        function apagarRegistro(id) {
            if (!confirm('Tem certeza que deseja apagar este registro?')) return;
            dados = dados.filter(d => d.id !== id);
            salvarLS();
            carregarLS();
            preencherCursosFiltro();
            renderTabela();
        }

        // --- Apagar tudo ---
        document.getElementById('btnApagarTudo').addEventListener('click', () => {
            if (!confirm('Apagar TODOS os registros? Essa ação não pode ser desfeita.')) return;
            dados = [];
            salvarLS();
            carregarLS();
            preencherCursosFiltro();
            renderTabela();
        });

        // --- Pesquisa e filtro ---
        searchInput.addEventListener('input', () => { paginaAtual = 1; renderTabela(); });
        filtrarCurso.addEventListener('change', () => { paginaAtual = 1; renderTabela(); });
        document.getElementById('btnClearFilters').addEventListener('click', () => {
            searchInput.value = ''; filtrarCurso.value = ''; renderTabela();
        });

        // --- Ordenação por botões e cabeçalho -->
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (currentSort.key === key) currentSort.dir *= -1;
                else { currentSort.key = key; currentSort.dir = 1; }
                renderTabela();
            });
        });
        document.getElementById('orderAsc').addEventListener('click', () => { currentSort = { key: 'nome', dir: 1 }; renderTabela(); });
        document.getElementById('orderDesc').addEventListener('click', () => { currentSort = { key: 'nome', dir: -1 }; renderTabela(); });

        // --- Export CSV e JSON e Imprimir ---
        function exportCSV() {
            if (!dados.length) { alert('Nada para exportar.'); return; }
            // respeita filtros e ordenação aplicadas
            let list = [...dados];
            const termo = searchInput.value.trim().toLowerCase();
            if (termo) list = list.filter(d => (d.nome || '').toLowerCase().includes(termo) || (d.email || '').toLowerCase().includes(termo) || (d.curso || '').toLowerCase().includes(termo));
            if (filtrarCurso.value) list = list.filter(d => d.curso === filtrarCurso.value);

            const headers = ['nome', 'email', 'telefone', 'idade', 'numero', 'curso', 'bi', 'morada'];
            const rows = [headers.join(',')];
            list.forEach(item => {
                const row = headers.map(h => `"${(item[h] || '').toString().replace(/"/g, '""')}"`).join(',');
                rows.push(row);
            });
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export_alunos.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            if (!dados.length) { alert('Nada para exportar.'); return; }
            const data = JSON.stringify(dados, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export_alunos.json';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
        document.getElementById('btnExportJSON').addEventListener('click', exportJSON);

        // Imprimir — cria nova janela com tabela filtrada e chama print
        document.getElementById('btnPrint').addEventListener('click', () => {
            let list = [...dados];
            const termo = searchInput.value.trim().toLowerCase();
            if (termo) list = list.filter(d => (d.nome || '').toLowerCase().includes(termo) || (d.email || '').toLowerCase().includes(termo) || (d.curso || '').toLowerCase().includes(termo));
            if (filtrarCurso.value) list = list.filter(d => d.curso === filtrarCurso.value);

            let html = `
    <html><head>
      <title>Exportar — Alunos</title>
      <style>body{font-family:Arial,Helvetica,sans-serif}table{width:100%;border-collapse:collapse}td,th{padding:8px;border:1px solid #ccc;text-align:left}img{width:60px;height:60px;object-fit:cover;border-radius:6px}</style>
    </head><body>
    <h3>Lista de Alunos</h3>
    <table><thead><tr><th>Foto</th><th>Nome</th><th>Email</th><th>Curso</th><th>Telefone</th><th>Nº Estudante</th></tr></thead><tbody>
  `;
            list.forEach(it => {
                html += `<tr>
      <td>${it.foto ? `<img src="${it.foto}">` : '—'}</td>
      <td>${it.nome || ''}</td>
      <td>${it.email || ''}</td>
      <td>${it.curso || ''}</td>
      <td>${it.telefone || ''}</td>
      <td>${it.numero || ''}</td>
    </tr>`;
            });
            html += `</tbody></table></body></html>`;

            const w = window.open('', '_blank', 'width=900,height=700');
            w.document.write(html);
            w.document.close();
            w.focus();
            // espera um pouco para carregar imagens e então chama print
            setTimeout(() => { w.print(); }, 700);
        });

        // --- Inicialização ---
        function init() {
            carregarLS();
            preencherCursosFiltro();
            renderTabela();
        }
        init();

        // --- Preenchimento automático do filtro quando mudar nos dados (observador simples) ---
        window.addEventListener('storage', () => { carregarLS(); preencherCursosFiltro(); renderTabela(); });

        // --- Expor funções para onclick na tabela (necessário pois criamos inline com strings) ---
        window.verDetalhes = verDetalhes;
        window.editarRegistro = editarRegistro;
        window.apagarRegistro = apagarRegistro;

    </script>
</body>

</html>